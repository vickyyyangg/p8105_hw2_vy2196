---
title: "p8105_hw2_vy2196"
output: github_document
---

### Problem 1

```{r}
library(tidyverse)
library(readxl)
library(janitor)
library(lubridate)
library(stringr)
library(dplyr)
library(knitr)

```


```{r message=FALSE, warning=FALSE}

pols_month_df = read_csv(file = "data/pols-month.csv") |>
    # break up the variable 
    separate(mon, into = c("year", "month", "day"), sep = "-") |>
  # replace month number with month name
  mutate(
    year = as.integer(year),
    month = factor(month.name[as.integer(month)],
                   levels = month.name, ordered = TRUE),
    president = case_when(
      prez_gop == 1 ~ "gop",
      prez_dem == 1 ~ "dem")) |>
  select(-prez_gop, -prez_dem, -day)
pols_month_df
```

```{r}
snp_df = read_csv(file = "data/snp.csv") |>
  janitor::clean_names() |>
  separate(date, into = c("month", "day", "year"), 
           sep = "/", convert = TRUE) |>
  mutate(
    year = ifelse(year < 50, 2000 + year,
                     ifelse(year < 100, 1900 + year, year)),
    year = as.integer(year)) |>
  mutate(month = factor(month(month, label = TRUE, abbr = FALSE),
                   levels = month.name, ordered = TRUE)) |>
  arrange(year, month) |>
  select(year, month, everything(), -day)

snp_df
```

```{r}
unemployment_df = read_csv(file = "data/unemployment.csv") |>
  # switch from wide to long
    pivot_longer(
      cols = Jan:Dec,
      names_to = "month",
      values_to = "unemployment") |>
  # Rename Year to year
  rename(year = Year) |>
  # Convert abbreviations to full month names
  mutate(
    year = as.integer(year),
    month = recode(month,
                   "Jan" = "January",
                   "Feb" = "February",
                   "Mar" = "March",
                   "Apr" = "April",
                   "May" = "May",
                   "Jun" = "June",
                   "Jul" = "July",
                   "Aug" = "August",
                   "Sep" = "September",
                   "Oct" = "October",
                   "Nov" = "November",
                   "Dec" = "December"),
    month = factor(month, levels = month.name, ordered = TRUE)) |>
  arrange(year, month) |>
  select(year, month, unemployment)
  
unemployment_df
```

```{r}
merged_data = 
  left_join(pols_month_df, snp_df, by = c("year", "month")) |> 
  left_join(x = _, y = unemployment_df, by = c("year", "month")) 
names(merged_data)
glimpse(merged_data)

merged_data

```

```{r}
# checking the range of year for each df
range(pols_month_df[["year"]])
range(snp_df[["year"]])
range(unemployment_df[["year"]])

```

#### Decription of cleaned dataset
The dimension of `pols_month_df` is 882 x 9, and the year range is from 1947 - 2015. I separated the date and only kept `year` and `month`. I also added a single column of `president` where its value is either `dem` or `gop`. 

The dimension of `snp_df` is 787 x 3, and the year range is from 1950 - 2015. I also separated the date and only kept `year` and `month`. I also turned the year from 2 digits to 4 digits to match the rest of the data.

The dimension of `unemployment_df` is 816 x 3 and the year range is from 1948 - 2015. I converted the format from wide to long, and renamed the variables of the month to match the rest of the data set. 


## Problem 2


```{r}
# Import and clean Mr. Trash Wheel
mr_trash = read_excel ("data/trash_wheel.xlsx", 
                       sheet = "Mr. Trash Wheel", range = "A2:N709") |>
  #Removes rows where the Dumpster column is blank
  filter(!is.na(Dumpster)) |>
  #Converts messy column names
  janitor::clean_names() |>
  mutate(
    #rounds sports ball counts to the nearest whole number
    sports_balls = as.integer(round(sports_balls)),
    year = as.integer(year),
    trash_wheel = "Mr. Trash Wheel")

mr_trash
```


```{r}
# Import and clean Professor Trash Wheel
prof_trash_wheel = read_excel ("data/trash_wheel.xlsx", 
                       sheet = "Professor Trash Wheel", range = "A2:M134") |>
  #Removes rows where the Dumpster column is blank
  filter(!is.na(Dumpster)) |>
  #Converts messy column names
  janitor::clean_names() |>
  mutate(trash_wheel = "Professor Trash Wheel",
         year = as.integer(year))

prof_trash_wheel
```

```{r}
# Import and clean Gwynns Falls Trash Wheel
gwynns_trash_wheel = read_excel ("data/trash_wheel.xlsx", 
                       sheet = "Gwynns Falls Trash Wheel") |>
  #Removes rows where the Dumpster column is blank
  filter(!is.na(Dumpster)) |>
  #Converts messy column names
  janitor::clean_names() |>
  mutate(trash_wheel = "Gwynns Falls Trash Wheel",
         year = as.integer(year))

gwynns_trash_wheel
```

```{r}
#combine data set

trash_wheel_data = bind_rows(
  mr_trash,
  prof_trash_wheel,
  gwynns_trash_wheel)

trash_wheel_data

```

### Summary Paragraph

```{r}
# Filter Gwynns June 2022
gwynns_june2022 = filter(trash_wheel_data,
                           trash_wheel == "Gwynns Falls Trash Wheel",
                           year == 2022,
                           month == "June")

# Total cigarette butts for Gwynns June 2022
gwynns_cigs_june22 = summarise(
  gwynns_june2022,
  total_cigs = sum(cigarette_butts, na.rm = TRUE)
)

# Total weight for Professor Trash Wheel
prof_total_weight = trash_wheel_data |>
  filter(trash_wheel == "Professor Trash Wheel") |>
  summarise(total_weight = sum(weight_tons, na.rm = TRUE))

```


The combined Trash Wheel data set contains 1188 observations. The key variables include `dumpster, month, year, date, weight, volume, plastic bottles, polystyrene, cigarette butts, glass bottles, plastic bags, wrappers, homes powered`. The total weight of trash collected by Professor Trash Wheel is `r round(prof_total_weight[["total_weight"]], 1)` tons of trash. Specifically for Gwynns Falls Trash Wheel on June 2022, Gwynns collected `r gwynns_cigs_june22[["total_cigs"]]` cigarette butts.


## Problem 3

```{r}
# cleaning zip_codes.csv

zip_codes_df = read_csv(file = "zillow_data/zip_codes.csv") |>
  janitor::clean_names() |>
  rename(date = file_date, county_name = county) |>
  #make sure all zip_code has 5 numbers
  mutate(ZipCode = str_pad(as.character(zip_code), 5, side = "left", pad = "0"),
         date = mdy(date)) |>
  #remove ZipCode
  select(-ZipCode, -county_code)

```


```{r}
# cleaning nyc_zipcodes.csv

nyc_zipcodes_df = read_csv(file = "zillow_data/nyc_zipcodes.csv") |>
  janitor::clean_names() |>
  mutate(RegionName = str_pad(as.character(region_name), 
                              5, side = "left", pad = "0")) |>
  rename(zip_code = region_name) |>
  #removing x in front of all the dates value
  rename_with(~ str_remove(.x, "^x")) |>
  #removing duplicates
  select(-region_type, -state, -RegionName)


#select all the dates and match the format
date_cols = nyc_zipcodes_df |>
  #match the dates format
  select(matches("^20\\d{2}_\\d{2}_\\d{2}$")) |>
  names()

#pivot all the dates
nyc_updated_df = nyc_zipcodes_df |>
  pivot_longer(
    cols = all_of(date_cols),   # only the date columns
    #put them under data columns
    names_to = "date",
    #store their vlaues under rent
    values_to = "rent") |>
  mutate(date = lubridate::ymd(date))

```

```{r}
#joining 2 datasets
final_df = zip_codes_df |>
  full_join(nyc_updated_df, by = c("zip_code", "date", "county_name"))
```


```{r}
#finding unique zip_code and neighborhood
final_df |> 
  summarise(
    unique_zips = n_distinct(zip_code),
    unique_neighborhoods = n_distinct(neighborhood))
```



### Description of the Final Dataset

There is a total of 17,606 observations. There is 320 unique ZIP codes and 43 unique neighborhoods.


```{r}
#only zip_code in zip_codes_df
zip_only = zip_codes_df |> 
  anti_join(nyc_updated_df, by = "zip_code")

# how many unique ZIPs
zip_only |> summarise(unique_missing_zips = n_distinct(zip_code))


```

There are `r nrow(zip_only)` ZIP codes in the ZIP code dataset that do not appear in the Zillow dataset. 
For example, the first few are: `r paste(head(zip_only$zip_code, 5), collapse = ", ")`. These ZIP codes might be excluded because some areas are not traditional residential areas such as universities, military bases, or hospitals. Another reason could be due to insufficient listings where Zillow does not have enough rental listings to compute reliable estimates. 


```{r}
#comparing rental prices

rent_change = final_df |>
  # Keep only January 2020 and 2021
  filter(month(date) == 1 & year(date) %in% c(2020, 2021)) |>
  mutate(year = year(date)) |>
  select(zip_code, borough = county_name, neighborhood, year, rent) |>
  pivot_wider(
    names_from = year,
    values_from = rent,
    names_prefix = "rent_"
  ) |>
  # Compute drop
  mutate(price_change = rent_2021 - rent_2020) |>
  arrange(price_change) |>   # most negative first
  slice_head(n = 10)

#table
kable(
  rent_change,
  caption = "Top 10 ZIP codes with largest rental price drop (Jan 2020 to Jan 2021)"
)
```



